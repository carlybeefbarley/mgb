<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>MyGameBuilder Code Tests Frame</title>

  <style type="text/css">
    body {
      margin: 0; height: 100%; width: 100%;
      background-color: #333;
    }
  </style>
</head>

<body>



<script>


window.addEventListener("message", receiveMessage, false)
let code, mgbData, mgbResults, mgbError

  function receiveMessage(mgbEvent)
  {
    mgbResults = []
    mgbError = null
    mgbData = mgbEvent.data
    code = mgbData.code
    
    // eval user code and save error message if is present
    try {
      eval(code)
    }
    catch(err) {
      mgbError = err.message
    }

    // eval additional functions for more complex tasks
    if(mgbData.tail){
      try {
        eval(mgbData.tail)
      }
      catch(err) {
        console.log('Tail error', err)
      }
    }

    // run tests. Note that some tests can have errors (because of user code)
    mgbData.tests.forEach((mgbTest) => {
      try {
        eval(mgbTest)
      }
      catch(err){
        // console.log('errror', err)
        // mgbError = err
        assert(false, mgbTest.split('message: ')[1])
      }
    })
  }


  function assert(mgbResult, mgbMessage){
    mgbResults.push({
      success: mgbResult ? true : false,
      message: mgbMessage
    })
    if(mgbResults.length == mgbData.tests.length){
      callback(mgbResults)
    }
  }

  function callback(mgbResults){
    const message = {
      prefix: 'codeTests',
      results: mgbResults,
      error: mgbError
    }
    window.parent.postMessage(message, "*")
    
  }


</script>




</body>

</html>
